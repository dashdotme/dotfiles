# Detect OS type
case "$(uname -s)" in
  Darwin*)
    OS_TYPE="macos"
    ;;
  Linux*)
    OS_TYPE="linux"
    ;;
  *)
    OS_TYPE="unknown"
    ;;
esac

export FZF_BASE=~/.fzf

# OS-specific configurations
if [ "$OS_TYPE" = "macos" ]; then
  # macOS-specific settings
  if [ -f /opt/homebrew/etc/profile.d/z.sh ]; then
    source /opt/homebrew/etc/profile.d/z.sh
  fi
else
  # Linux-specific settings
  export NIX_TARGET="${NIX_TARGET:-$([ -e /sys/class/power_supply/BAT0 ] && echo "xps" || echo "home")}"
  alias rebuild="sudo nixos-rebuild switch --flake /etc/nixos#$NIX_TARGET"
  if [ -f /usr/share/z/z.sh ]; then
    source /usr/share/z/z.sh
  elif [ -f $HOME/z/z.sh ]; then
    source $HOME/z/z.sh
  fi
  # pywal theming
  (cat ~/.cache/wal/sequences &)
  eval "$(zoxide init zsh)"
fi

export ZSH="$HOME/.oh-my-zsh"

ZSH_THEME="frisk2"

# Base plugins that work universally
plugins=(git fzf zsh-interactive-cd docker colored-man-pages)

# Check for plugin existence before adding to the list
for plugin in zsh-autosuggestions zsh-syntax-highlighting zsh-completions; do
  if [ -d "${ZSH_CUSTOM:-$ZSH/custom}/plugins/$plugin" ] || [ -d "$ZSH/plugins/$plugin" ]; then
    plugins+=($plugin)
  else
    echo "[oh-my-zsh] plugin '$plugin' not found. Install with:"
    echo "git clone https://github.com/zsh-users/$plugin ${ZSH_CUSTOM:-$ZSH/custom}/plugins/$plugin"
  fi
done

source $ZSH/oh-my-zsh.sh

# User configuration

# Preferred editor for local and remote sessions
if [[ -n $SSH_CONNECTION ]]; then
  export EDITOR='vim'
else
  export EDITOR='nvim'
fi

# Aliases
alias python="python3"

# Java setup - OS specific
if [ "$OS_TYPE" = "macos" ]; then
  # macOS Java configuration
  if [ -x /usr/libexec/java_home ]; then
    export JAVA_HOME=$(/usr/libexec/java_home -v 23 2>/dev/null || /usr/libexec/java_home 2>/dev/null)
    export PATH="$JAVA_HOME/bin:$PATH"
    export PATH="/opt/homebrew/opt/openjdk/bin:$PATH"
  fi
elif [ "$OS_TYPE" = "linux" ]; then
  # Linux Java configuration - uncomment and adjust if needed
  # Try to find Java automatically
  # Temporarily set NULL_GLOB to prevent errors when patterns don't match
  setopt NULL_GLOB 2>/dev/null || true
  for java_path in /usr/lib/jvm/default-java /usr/lib/jvm/java-[0-9]*-openjdk* /usr/lib/jvm/java-[0-9]*-oracle; do
    if [ -d "$java_path" ]; then
      export JAVA_HOME="$java_path"
      export PATH="$JAVA_HOME/bin:$PATH"
      break
    fi
  done
  # Reset to default globbing behavior
  unsetopt NULL_GLOB 2>/dev/null || true
fi

# Terraform completion
if command -v terraform &>/dev/null; then
  autoload -U +X bashcompinit && bashcompinit
  complete -o nospace -C $(which terraform) terraform
fi

# uv completion - if installed
if command -v uv &>/dev/null; then
  eval "$(uv generate-shell-completion zsh 2>/dev/null || true)"
fi

# Environment file - check if exists before sourcing
if [ -f "$HOME/.local/bin/env" ]; then
  . "$HOME/.local/bin/env"
fi

# fnm (Fast Node Manager) - OS specific paths
if [ "$OS_TYPE" = "macos" ]; then
  FNM_PATH="/Users/dashvallance/Library/Application Support/fnm"
  eval "$(fnm env --use-on-cd --shell zsh)"
else
  FNM_PATH="$HOME/.local/share/fnm"
fi

# Load fnm if it exists at the detected path
if [ -d "$FNM_PATH" ]; then
  export PATH="$FNM_PATH:$PATH"
  command -v fnm &>/dev/null && eval "$(fnm env 2>/dev/null || true)"

  # fnm autocomplete
  command -v fnm &>/dev/null && eval "$(fnm env --use-on-cd --shell zsh 2>/dev/null || true)"
fi

# GitHub username
export GITHUB_USERNAME=dashdotme

# Note for setup:
# Run the following commands to install missing plugins:
#
# git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
# git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
# git clone https://github.com/zsh-users/zsh-completions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-completions

fcd() {
    local dir
    dir=$(find ${1:-.} -type d 2> /dev/null | fzf +m) && cd "$dir"
}

